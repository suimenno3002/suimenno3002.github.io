<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>漫谈红包雨方案设计 | suimenno3002's blog</title>
<meta name=keywords content><meta name=description content="简介 虽然红包雨复杂度低，但是是 C 端典型（或者说少有）的大流量写业务场景，且需要保障资金安全，根据业务形态和宣传资源，QPS 可达数万至数千万不等，可借由方案的推敲和设计一窥 C 端大流量核心场景系统设计的原则，和互联网后端工程师的核心能力模型 —— 大流量高并发下的系统设计和稳定性与容灾保障。
本文不会涉及具体的方案设计，只能泛泛而谈，希望能给读者一些启发。
需求概述 活动期内，每天定时领取红包。
业务价值 通过玩法将用户导量到入口和出口的场景。
比如免登录态参与玩法引导用户注册。比如玩完红包雨后跳转到春节活动主会场引导用户玩其他玩法。比如在聊天玩红包雨提升群聊活跃度。
流量预估 峰值流量取决于入口流量和玩法漏斗转化率，进而取决于：
宣传入口：如春晚口播、全局弹窗、feed 流强插、挂件等，其中最有效的是春晚口播和全局弹窗 用户数量：一般按高峰活跃用户数量估计，如有往年数据可以直接以 DAU 比例计算，如果定向圈人则需考虑圈人比例 是否打散：打散是削峰的关键，需要除以打散时长，一般推崇向前打散 玩法转化：如有往年数据可直接参考，如无则需依赖产品估算各级漏斗转化率给口径 流量预估会进行多次，一般是需求评审后 RD 会拍个粗估的峰值去做技术方案，开发期间 RD 和产品经过多轮讨论才能给出细化的预估，最终会通过演练场次算出精确的流量预估。此外对于红包雨这种玩法，在初期是无法确定真实的流量范围的，是否有春晚口播、是否使用全局弹窗，这些都不是前期能定下来的，所以初期技术方案设计上得按高估计。
不过如果产品往年做过类似玩法，可以参考往年数据进行粗估。
如有春晚口播，初期流量预估可以直接按该玩法普通导流方式的流量乘以十倍。
技术方案 技术挑战 大流量与高并发 应对挑战：
开始时会瞬间涌入大量用户 配置下发、玩法产生大量请求，对机房带宽产生压力 与秒杀不同，红包雨需要尽量保证用户能领取到奖励，大量请求能走完领奖的完整流程 解决方案：
入口打散 减少网络交互，接口简单 限流 提前建连保活 稳定性与容灾 应对挑战：
高并发下的玩法体验，保证服务稳定性 故障时的快速止损，恢复玩法体验 解决方案：
简化玩法，链路尽可能短，强依赖尽可能少 合理的重试、超时、限流配置 热备异构存储，设计合理的存储一致性维护方案 资金安全保障 应对挑战：
预算充足时正常发放，预算不足时发放兜底 每个用户的奖励需由策略算出，不能提前拆红包 保证各种情况下，不超发 解决方案：
合理设计预算控制模块抗超高流量的预算检查和扣除 梳理各种异常情况的兜底表现 幂等入账 对账、熔断、一致性校验 决策分歧点 附加需求 不展开
边缘机房 or 核心机房 机房分为核心机房和边缘机房，流量一般由边缘机房流向核心机房，边缘机房的特点是离用户更近，带宽承载能力更强，基础设施建设相对不完善。
选择流量终结在边缘机房的原因可能是：
极高稳定性和延迟要求 不希望超高流量打到核心机房影响核心业务 边缘机房到核心机房的带宽建设不足，可能无法承载超高流量 物理机 or 容器 在极端性能敏感或极致服务设计的情况下可以使用物理机，物理机的好处是："><meta name=author content="suimenno3002"><link rel=canonical href=http://suimenno3002.github.io/posts/%E6%BC%AB%E8%B0%88%E7%BA%A2%E5%8C%85%E9%9B%A8%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.491c74fb4d187c3956d2e9d2087197eca8be54b870a58e79451ab84c25aa5b65.css integrity="sha256-SRx0+00YfDlW0unSCHGX7Ki+VLhwpY55RRq4TCWqW2U=" rel="preload stylesheet" as=style><link rel=icon href=http://suimenno3002.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=http://suimenno3002.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=http://suimenno3002.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=http://suimenno3002.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=http://suimenno3002.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=http://suimenno3002.github.io/posts/%E6%BC%AB%E8%B0%88%E7%BA%A2%E5%8C%85%E9%9B%A8%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-VE0D4BXTS2"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-VE0D4BXTS2")}</script><meta property="og:title" content="漫谈红包雨方案设计"><meta property="og:description" content="简介 虽然红包雨复杂度低，但是是 C 端典型（或者说少有）的大流量写业务场景，且需要保障资金安全，根据业务形态和宣传资源，QPS 可达数万至数千万不等，可借由方案的推敲和设计一窥 C 端大流量核心场景系统设计的原则，和互联网后端工程师的核心能力模型 —— 大流量高并发下的系统设计和稳定性与容灾保障。
本文不会涉及具体的方案设计，只能泛泛而谈，希望能给读者一些启发。
需求概述 活动期内，每天定时领取红包。
业务价值 通过玩法将用户导量到入口和出口的场景。
比如免登录态参与玩法引导用户注册。比如玩完红包雨后跳转到春节活动主会场引导用户玩其他玩法。比如在聊天玩红包雨提升群聊活跃度。
流量预估 峰值流量取决于入口流量和玩法漏斗转化率，进而取决于：
宣传入口：如春晚口播、全局弹窗、feed 流强插、挂件等，其中最有效的是春晚口播和全局弹窗 用户数量：一般按高峰活跃用户数量估计，如有往年数据可以直接以 DAU 比例计算，如果定向圈人则需考虑圈人比例 是否打散：打散是削峰的关键，需要除以打散时长，一般推崇向前打散 玩法转化：如有往年数据可直接参考，如无则需依赖产品估算各级漏斗转化率给口径 流量预估会进行多次，一般是需求评审后 RD 会拍个粗估的峰值去做技术方案，开发期间 RD 和产品经过多轮讨论才能给出细化的预估，最终会通过演练场次算出精确的流量预估。此外对于红包雨这种玩法，在初期是无法确定真实的流量范围的，是否有春晚口播、是否使用全局弹窗，这些都不是前期能定下来的，所以初期技术方案设计上得按高估计。
不过如果产品往年做过类似玩法，可以参考往年数据进行粗估。
如有春晚口播，初期流量预估可以直接按该玩法普通导流方式的流量乘以十倍。
技术方案 技术挑战 大流量与高并发 应对挑战：
开始时会瞬间涌入大量用户 配置下发、玩法产生大量请求，对机房带宽产生压力 与秒杀不同，红包雨需要尽量保证用户能领取到奖励，大量请求能走完领奖的完整流程 解决方案：
入口打散 减少网络交互，接口简单 限流 提前建连保活 稳定性与容灾 应对挑战：
高并发下的玩法体验，保证服务稳定性 故障时的快速止损，恢复玩法体验 解决方案：
简化玩法，链路尽可能短，强依赖尽可能少 合理的重试、超时、限流配置 热备异构存储，设计合理的存储一致性维护方案 资金安全保障 应对挑战：
预算充足时正常发放，预算不足时发放兜底 每个用户的奖励需由策略算出，不能提前拆红包 保证各种情况下，不超发 解决方案：
合理设计预算控制模块抗超高流量的预算检查和扣除 梳理各种异常情况的兜底表现 幂等入账 对账、熔断、一致性校验 决策分歧点 附加需求 不展开
边缘机房 or 核心机房 机房分为核心机房和边缘机房，流量一般由边缘机房流向核心机房，边缘机房的特点是离用户更近，带宽承载能力更强，基础设施建设相对不完善。
选择流量终结在边缘机房的原因可能是：
极高稳定性和延迟要求 不希望超高流量打到核心机房影响核心业务 边缘机房到核心机房的带宽建设不足，可能无法承载超高流量 物理机 or 容器 在极端性能敏感或极致服务设计的情况下可以使用物理机，物理机的好处是："><meta property="og:type" content="article"><meta property="og:url" content="http://suimenno3002.github.io/posts/%E6%BC%AB%E8%B0%88%E7%BA%A2%E5%8C%85%E9%9B%A8%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1/"><meta property="og:image" content="http://suimenno3002.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="og:site_name" content="suimenno3002's blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://suimenno3002.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="漫谈红包雨方案设计"><meta name=twitter:description content="简介 虽然红包雨复杂度低，但是是 C 端典型（或者说少有）的大流量写业务场景，且需要保障资金安全，根据业务形态和宣传资源，QPS 可达数万至数千万不等，可借由方案的推敲和设计一窥 C 端大流量核心场景系统设计的原则，和互联网后端工程师的核心能力模型 —— 大流量高并发下的系统设计和稳定性与容灾保障。
本文不会涉及具体的方案设计，只能泛泛而谈，希望能给读者一些启发。
需求概述 活动期内，每天定时领取红包。
业务价值 通过玩法将用户导量到入口和出口的场景。
比如免登录态参与玩法引导用户注册。比如玩完红包雨后跳转到春节活动主会场引导用户玩其他玩法。比如在聊天玩红包雨提升群聊活跃度。
流量预估 峰值流量取决于入口流量和玩法漏斗转化率，进而取决于：
宣传入口：如春晚口播、全局弹窗、feed 流强插、挂件等，其中最有效的是春晚口播和全局弹窗 用户数量：一般按高峰活跃用户数量估计，如有往年数据可以直接以 DAU 比例计算，如果定向圈人则需考虑圈人比例 是否打散：打散是削峰的关键，需要除以打散时长，一般推崇向前打散 玩法转化：如有往年数据可直接参考，如无则需依赖产品估算各级漏斗转化率给口径 流量预估会进行多次，一般是需求评审后 RD 会拍个粗估的峰值去做技术方案，开发期间 RD 和产品经过多轮讨论才能给出细化的预估，最终会通过演练场次算出精确的流量预估。此外对于红包雨这种玩法，在初期是无法确定真实的流量范围的，是否有春晚口播、是否使用全局弹窗，这些都不是前期能定下来的，所以初期技术方案设计上得按高估计。
不过如果产品往年做过类似玩法，可以参考往年数据进行粗估。
如有春晚口播，初期流量预估可以直接按该玩法普通导流方式的流量乘以十倍。
技术方案 技术挑战 大流量与高并发 应对挑战：
开始时会瞬间涌入大量用户 配置下发、玩法产生大量请求，对机房带宽产生压力 与秒杀不同，红包雨需要尽量保证用户能领取到奖励，大量请求能走完领奖的完整流程 解决方案：
入口打散 减少网络交互，接口简单 限流 提前建连保活 稳定性与容灾 应对挑战：
高并发下的玩法体验，保证服务稳定性 故障时的快速止损，恢复玩法体验 解决方案：
简化玩法，链路尽可能短，强依赖尽可能少 合理的重试、超时、限流配置 热备异构存储，设计合理的存储一致性维护方案 资金安全保障 应对挑战：
预算充足时正常发放，预算不足时发放兜底 每个用户的奖励需由策略算出，不能提前拆红包 保证各种情况下，不超发 解决方案：
合理设计预算控制模块抗超高流量的预算检查和扣除 梳理各种异常情况的兜底表现 幂等入账 对账、熔断、一致性校验 决策分歧点 附加需求 不展开
边缘机房 or 核心机房 机房分为核心机房和边缘机房，流量一般由边缘机房流向核心机房，边缘机房的特点是离用户更近，带宽承载能力更强，基础设施建设相对不完善。
选择流量终结在边缘机房的原因可能是：
极高稳定性和延迟要求 不希望超高流量打到核心机房影响核心业务 边缘机房到核心机房的带宽建设不足，可能无法承载超高流量 物理机 or 容器 在极端性能敏感或极致服务设计的情况下可以使用物理机，物理机的好处是："><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"http://suimenno3002.github.io/posts/"},{"@type":"ListItem","position":2,"name":"漫谈红包雨方案设计","item":"http://suimenno3002.github.io/posts/%E6%BC%AB%E8%B0%88%E7%BA%A2%E5%8C%85%E9%9B%A8%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"漫谈红包雨方案设计","name":"漫谈红包雨方案设计","description":"简介 虽然红包雨复杂度低，但是是 C 端典型（或者说少有）的大流量写业务场景，且需要保障资金安全，根据业务形态和宣传资源，QPS 可达数万至数千万不等，可借由方案的推敲和设计一窥 C 端大流量核心场景系统设计的原则，和互联网后端工程师的核心能力模型 —— 大流量高并发下的系统设计和稳定性与容灾保障。\n本文不会涉及具体的方案设计，只能泛泛而谈，希望能给读者一些启发。\n需求概述 活动期内，每天定时领取红包。\n业务价值 通过玩法将用户导量到入口和出口的场景。\n比如免登录态参与玩法引导用户注册。比如玩完红包雨后跳转到春节活动主会场引导用户玩其他玩法。比如在聊天玩红包雨提升群聊活跃度。\n流量预估 峰值流量取决于入口流量和玩法漏斗转化率，进而取决于：\n宣传入口：如春晚口播、全局弹窗、feed 流强插、挂件等，其中最有效的是春晚口播和全局弹窗 用户数量：一般按高峰活跃用户数量估计，如有往年数据可以直接以 DAU 比例计算，如果定向圈人则需考虑圈人比例 是否打散：打散是削峰的关键，需要除以打散时长，一般推崇向前打散 玩法转化：如有往年数据可直接参考，如无则需依赖产品估算各级漏斗转化率给口径 流量预估会进行多次，一般是需求评审后 RD 会拍个粗估的峰值去做技术方案，开发期间 RD 和产品经过多轮讨论才能给出细化的预估，最终会通过演练场次算出精确的流量预估。此外对于红包雨这种玩法，在初期是无法确定真实的流量范围的，是否有春晚口播、是否使用全局弹窗，这些都不是前期能定下来的，所以初期技术方案设计上得按高估计。\n不过如果产品往年做过类似玩法，可以参考往年数据进行粗估。\n如有春晚口播，初期流量预估可以直接按该玩法普通导流方式的流量乘以十倍。\n技术方案 技术挑战 大流量与高并发 应对挑战：\n开始时会瞬间涌入大量用户 配置下发、玩法产生大量请求，对机房带宽产生压力 与秒杀不同，红包雨需要尽量保证用户能领取到奖励，大量请求能走完领奖的完整流程 解决方案：\n入口打散 减少网络交互，接口简单 限流 提前建连保活 稳定性与容灾 应对挑战：\n高并发下的玩法体验，保证服务稳定性 故障时的快速止损，恢复玩法体验 解决方案：\n简化玩法，链路尽可能短，强依赖尽可能少 合理的重试、超时、限流配置 热备异构存储，设计合理的存储一致性维护方案 资金安全保障 应对挑战：\n预算充足时正常发放，预算不足时发放兜底 每个用户的奖励需由策略算出，不能提前拆红包 保证各种情况下，不超发 解决方案：\n合理设计预算控制模块抗超高流量的预算检查和扣除 梳理各种异常情况的兜底表现 幂等入账 对账、熔断、一致性校验 决策分歧点 附加需求 不展开\n边缘机房 or 核心机房 机房分为核心机房和边缘机房，流量一般由边缘机房流向核心机房，边缘机房的特点是离用户更近，带宽承载能力更强，基础设施建设相对不完善。\n选择流量终结在边缘机房的原因可能是：\n极高稳定性和延迟要求 不希望超高流量打到核心机房影响核心业务 边缘机房到核心机房的带宽建设不足，可能无法承载超高流量 物理机 or 容器 在极端性能敏感或极致服务设计的情况下可以使用物理机，物理机的好处是：","keywords":[],"articleBody":"简介 虽然红包雨复杂度低，但是是 C 端典型（或者说少有）的大流量写业务场景，且需要保障资金安全，根据业务形态和宣传资源，QPS 可达数万至数千万不等，可借由方案的推敲和设计一窥 C 端大流量核心场景系统设计的原则，和互联网后端工程师的核心能力模型 —— 大流量高并发下的系统设计和稳定性与容灾保障。\n本文不会涉及具体的方案设计，只能泛泛而谈，希望能给读者一些启发。\n需求概述 活动期内，每天定时领取红包。\n业务价值 通过玩法将用户导量到入口和出口的场景。\n比如免登录态参与玩法引导用户注册。比如玩完红包雨后跳转到春节活动主会场引导用户玩其他玩法。比如在聊天玩红包雨提升群聊活跃度。\n流量预估 峰值流量取决于入口流量和玩法漏斗转化率，进而取决于：\n宣传入口：如春晚口播、全局弹窗、feed 流强插、挂件等，其中最有效的是春晚口播和全局弹窗 用户数量：一般按高峰活跃用户数量估计，如有往年数据可以直接以 DAU 比例计算，如果定向圈人则需考虑圈人比例 是否打散：打散是削峰的关键，需要除以打散时长，一般推崇向前打散 玩法转化：如有往年数据可直接参考，如无则需依赖产品估算各级漏斗转化率给口径 流量预估会进行多次，一般是需求评审后 RD 会拍个粗估的峰值去做技术方案，开发期间 RD 和产品经过多轮讨论才能给出细化的预估，最终会通过演练场次算出精确的流量预估。此外对于红包雨这种玩法，在初期是无法确定真实的流量范围的，是否有春晚口播、是否使用全局弹窗，这些都不是前期能定下来的，所以初期技术方案设计上得按高估计。\n不过如果产品往年做过类似玩法，可以参考往年数据进行粗估。\n如有春晚口播，初期流量预估可以直接按该玩法普通导流方式的流量乘以十倍。\n技术方案 技术挑战 大流量与高并发 应对挑战：\n开始时会瞬间涌入大量用户 配置下发、玩法产生大量请求，对机房带宽产生压力 与秒杀不同，红包雨需要尽量保证用户能领取到奖励，大量请求能走完领奖的完整流程 解决方案：\n入口打散 减少网络交互，接口简单 限流 提前建连保活 稳定性与容灾 应对挑战：\n高并发下的玩法体验，保证服务稳定性 故障时的快速止损，恢复玩法体验 解决方案：\n简化玩法，链路尽可能短，强依赖尽可能少 合理的重试、超时、限流配置 热备异构存储，设计合理的存储一致性维护方案 资金安全保障 应对挑战：\n预算充足时正常发放，预算不足时发放兜底 每个用户的奖励需由策略算出，不能提前拆红包 保证各种情况下，不超发 解决方案：\n合理设计预算控制模块抗超高流量的预算检查和扣除 梳理各种异常情况的兜底表现 幂等入账 对账、熔断、一致性校验 决策分歧点 附加需求 不展开\n边缘机房 or 核心机房 机房分为核心机房和边缘机房，流量一般由边缘机房流向核心机房，边缘机房的特点是离用户更近，带宽承载能力更强，基础设施建设相对不完善。\n选择流量终结在边缘机房的原因可能是：\n极高稳定性和延迟要求 不希望超高流量打到核心机房影响核心业务 边缘机房到核心机房的带宽建设不足，可能无法承载超高流量 物理机 or 容器 在极端性能敏感或极致服务设计的情况下可以使用物理机，物理机的好处是：\n无容器带来的开销，对 CPU 调度器更友好 无在离线混部、容器超卖的影响，服务更稳定不容易抖动 容易在单机内部署多个进程，做本地基于共享内存的本地调用，省去网络开销 容易实现有状态服务 流量终结在物理机单机，符合超高流量服务的实践经验（关键路径无 RPC / 减少 RPC） 物理机的坏处是：\n技术栈相对不通用 一般和有状态服务设计强绑定，无法 scale out 单机丢数据即数据丢失，无法利用底层存储的冗余能力兜底 ","wordCount":"93","inLanguage":"en","image":"http://suimenno3002.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","author":{"@type":"Person","name":"suimenno3002"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://suimenno3002.github.io/posts/%E6%BC%AB%E8%B0%88%E7%BA%A2%E5%8C%85%E9%9B%A8%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1/"},"publisher":{"@type":"Organization","name":"suimenno3002's blog","logo":{"@type":"ImageObject","url":"http://suimenno3002.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://suimenno3002.github.io/ accesskey=h title="Home (Alt + H)"><img src=http://suimenno3002.github.io/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=http://suimenno3002.github.io/archives title=文章><span>文章</span></a></li><li><a href=http://suimenno3002.github.io/series title=系列><span>系列</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=http://suimenno3002.github.io/>Home</a>&nbsp;»&nbsp;<a href=http://suimenno3002.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">漫谈红包雨方案设计</h1><div class=post-meta>suimenno3002&nbsp;|&nbsp;<a href=https://github.com/%3cpath_to_repo%3e/content/posts/%e6%bc%ab%e8%b0%88%e7%ba%a2%e5%8c%85%e9%9b%a8%e6%96%b9%e6%a1%88%e8%ae%be%e8%ae%a1.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#简介>简介</a></li><li><a href=#需求概述>需求概述</a></li><li><a href=#业务价值>业务价值</a></li><li><a href=#流量预估>流量预估</a></li><li><a href=#技术方案>技术方案</a><ul><li><a href=#技术挑战>技术挑战</a></li><li><a href=#大流量与高并发>大流量与高并发</a></li><li><a href=#稳定性与容灾>稳定性与容灾</a></li><li><a href=#资金安全保障>资金安全保障</a></li><li><a href=#决策分歧点>决策分歧点</a></li><li><a href=#附加需求>附加需求</a></li><li><a href=#边缘机房-or-核心机房>边缘机房 or 核心机房</a></li><li><a href=#物理机-or-容器>物理机 or 容器</a></li></ul></li></ul></nav></div></details></div><div class=post-content><h2 id=简介>简介<a hidden class=anchor aria-hidden=true href=#简介>#</a></h2><p>虽然红包雨复杂度低，但是是 C 端典型（或者说少有）的大流量写业务场景，且需要保障资金安全，根据业务形态和宣传资源，QPS 可达数万至数千万不等，可借由方案的推敲和设计一窥 C 端大流量核心场景系统设计的原则，和互联网后端工程师的核心能力模型 —— 大流量高并发下的系统设计和稳定性与容灾保障。</p><p>本文不会涉及具体的方案设计，只能泛泛而谈，希望能给读者一些启发。</p><h2 id=需求概述>需求概述<a hidden class=anchor aria-hidden=true href=#需求概述>#</a></h2><p>活动期内，每天定时领取红包。</p><h2 id=业务价值>业务价值<a hidden class=anchor aria-hidden=true href=#业务价值>#</a></h2><p>通过玩法将用户导量到入口和出口的场景。</p><p>比如免登录态参与玩法引导用户注册。比如玩完红包雨后跳转到春节活动主会场引导用户玩其他玩法。比如在聊天玩红包雨提升群聊活跃度。</p><h2 id=流量预估>流量预估<a hidden class=anchor aria-hidden=true href=#流量预估>#</a></h2><p>峰值流量取决于入口流量和玩法漏斗转化率，进而取决于：</p><ul><li>宣传入口：如春晚口播、全局弹窗、feed 流强插、挂件等，其中最有效的是春晚口播和全局弹窗</li><li>用户数量：一般按高峰活跃用户数量估计，如有往年数据可以直接以 DAU 比例计算，如果定向圈人则需考虑圈人比例</li><li>是否打散：打散是削峰的关键，需要除以打散时长，一般推崇向前打散</li><li>玩法转化：如有往年数据可直接参考，如无则需依赖产品估算各级漏斗转化率给口径</li></ul><p>流量预估会进行多次，一般是需求评审后 RD 会拍个粗估的峰值去做技术方案，开发期间 RD 和产品经过多轮讨论才能给出细化的预估，最终会通过演练场次算出精确的流量预估。此外对于红包雨这种玩法，在初期是无法确定真实的流量范围的，是否有春晚口播、是否使用全局弹窗，这些都不是前期能定下来的，所以初期技术方案设计上得按高估计。</p><p>不过如果产品往年做过类似玩法，可以参考往年数据进行粗估。</p><p>如有春晚口播，初期流量预估可以直接按该玩法普通导流方式的流量乘以十倍。</p><h2 id=技术方案>技术方案<a hidden class=anchor aria-hidden=true href=#技术方案>#</a></h2><h3 id=技术挑战>技术挑战<a hidden class=anchor aria-hidden=true href=#技术挑战>#</a></h3><h3 id=大流量与高并发>大流量与高并发<a hidden class=anchor aria-hidden=true href=#大流量与高并发>#</a></h3><p>应对挑战：</p><ul><li>开始时会瞬间涌入大量用户</li><li>配置下发、玩法产生大量请求，对机房带宽产生压力</li><li>与秒杀不同，红包雨需要尽量保证用户能领取到奖励，大量请求能走完领奖的完整流程</li></ul><p>解决方案：</p><ul><li><a href=https://zhuanlan.zhihu.com/p/711436696/%E5%85%A5%E5%8F%A3%E6%89%93%E6%95%A3.md>入口打散</a></li><li>减少网络交互，接口简单</li><li>限流</li><li>提前建连保活</li></ul><h3 id=稳定性与容灾>稳定性与容灾<a hidden class=anchor aria-hidden=true href=#稳定性与容灾>#</a></h3><p>应对挑战：</p><ul><li>高并发下的玩法体验，保证服务稳定性</li><li>故障时的快速止损，恢复玩法体验</li></ul><p>解决方案：</p><ul><li>简化玩法，链路尽可能短，强依赖尽可能少</li><li>合理的重试、超时、限流配置</li><li>热备异构存储，设计合理的存储一致性维护方案</li></ul><h3 id=资金安全保障>资金安全保障<a hidden class=anchor aria-hidden=true href=#资金安全保障>#</a></h3><p>应对挑战：</p><ul><li>预算充足时正常发放，预算不足时发放兜底</li><li>每个用户的奖励需由策略算出，不能提前拆红包</li><li>保证各种情况下，不超发</li></ul><p>解决方案：</p><ul><li>合理设计预算控制模块抗超高流量的预算检查和扣除</li><li>梳理各种异常情况的兜底表现</li><li>幂等入账</li><li>对账、熔断、一致性校验</li></ul><h3 id=决策分歧点>决策分歧点<a hidden class=anchor aria-hidden=true href=#决策分歧点>#</a></h3><h3 id=附加需求>附加需求<a hidden class=anchor aria-hidden=true href=#附加需求>#</a></h3><blockquote><p>不展开</p></blockquote><h3 id=边缘机房-or-核心机房>边缘机房 or 核心机房<a hidden class=anchor aria-hidden=true href=#边缘机房-or-核心机房>#</a></h3><p>机房分为核心机房和边缘机房，流量一般由边缘机房流向核心机房，边缘机房的特点是离用户更近，带宽承载能力更强，基础设施建设相对不完善。</p><p>选择流量终结在边缘机房的原因可能是：</p><ul><li>极高稳定性和延迟要求</li><li>不希望超高流量打到核心机房影响核心业务</li><li>边缘机房到核心机房的带宽建设不足，可能无法承载超高流量</li></ul><h3 id=物理机-or-容器>物理机 or 容器<a hidden class=anchor aria-hidden=true href=#物理机-or-容器>#</a></h3><p>在极端性能敏感或极致服务设计的情况下可以使用物理机，物理机的好处是：</p><ul><li>无容器带来的开销，对 CPU 调度器更友好</li><li>无在离线混部、容器超卖的影响，服务更稳定不容易抖动</li><li>容易在单机内部署多个进程，做本地基于共享内存的本地调用，省去网络开销</li><li>容易实现有状态服务</li><li>流量终结在物理机单机，符合超高流量服务的实践经验（关键路径无 RPC / 减少 RPC）</li></ul><p>物理机的坏处是：</p><ul><li>技术栈相对不通用</li><li>一般和有状态服务设计强绑定，无法 scale out</li><li>单机丢数据即数据丢失，无法利用底层存储的冗余能力兜底</li></ul></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=http://suimenno3002.github.io/posts/hello-world/><span class=title>« Prev</span><br><span>Hello World</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=http://suimenno3002.github.io/>suimenno3002's blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>